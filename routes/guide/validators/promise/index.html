<svelte:head>
	<title>FormValidation â€¢ promise validator</title>
</svelte:head>

<Guide>
    <h1 class="f3 f2-m f1-l tc">promise validator</h1>
    <h2 class="f4 fw4 tc">Use Promise to validate value</h2>

    <section class="mb4">
        <h2><span class="bb b--gray">Options</span></h2>

        <h3>Using with form field</h3>
        <p class="lh-copy i"><sup>*</sup> presents a required option. The HTML attributes are used to set the validator options via the <a href="/guide/plugins/declarative/" class="blue dim link">Declarative</a> plugin</p>
        <table class="collapse ba br2 b--black-10 pv2 ph3 w-100 mb4">
            <tr class="striped--light-gray">
                <th class="pv2 ph3 tl f6 fw6 ttu">Name</th>
                <th class="pv2 ph3 tl f6 fw6 ttu">HTML attribute</th>
                <th class="pv2 ph3 tl f6 fw6 ttu">Type</th>
                <th class="pv2 ph3 tl f6 fw6 ttu">Description</th>
            </tr>
            <tr class="striped--light-gray">
                <td class="pv2 ph3"><code>message</code></td>
                <td class="pv2 ph3"><code>data-fv-promise___message</code></td>
                <td class="pv2 ph3">String</td>
                <td class="pv2 ph3">The error message</td>
            </tr>
            <tr class="striped--light-gray">
                <td class="pv2 ph3"><code>promise</code><sup>*</sup></td>
                <td class="pv2 ph3"><code>data-fv-promise___promise</code></td>
                <td class="pv2 ph3">String or Function</td>
                <td class="pv2 ph3">The callback returns promise instance</td>
            </tr>
        </table>

        <p class="lh-copy">The <code>promise</code> option must be a function or the name of function which returns a Promise as following:</p>
        <SampleCode lang="javascript" code={`
promise: function(input) {
    // input.value is the value of field
    // input.element is the field element
    return new Promise(function(resolve, reject) {
        // Do something ...

        // Resolve when particular task is done
        resolve({
            valid: true, // or false,   // Required
            message: 'Other message',   // Optional
            // You can attach more data to reuse later
            meta: {
                key: value
            },
        });

        // You can reject if there is error
        reject({
            valid: false,               // Required
            message: 'Other message',   // Optional
            // You can attach more data to reuse later
            meta: {
                key: value
            },
        });
    });
}
`} />
    </section>

    <section class="mb4">
        <h2><span class="bb b--gray">Basic Example</span></h2>

        <p class="lh-copy">The following form asks user to upload an avatar which both width and height must be less than 300px.</p>
        <Tip>Use the <a href="/guide/validators/file/" class="blue dim link">file</a> validator if you want to validate size of an image</Tip>
        <p class="lh-copy">They can be determined using Promise as seen in the following snippet:</p>

        <div class="mb4">
            <SampleCode lang="javascript" code={`
promise: function(input) {
    return new Promise(function(resolve, reject) {
        const files = input.element.files
        if (!files.length || typeof FileReader === 'undefined') {
            resolve({
                valid: true,
            });
        }

        const img = new Image();
        img.addEventListener('load', function() {
            const w = this.width;
            const h = this.height;

            resolve({
                valid: (w <= 300 && h <= 300),
                message: 'The avatar width and height must be less than 300 px',
                meta: {
                    // We will use it later to show the preview
                    source: img.src,
                    width: w,
                    height: h,
                },
            });
        });
        img.addEventListener('error', function() {
            reject({
                valid: false,
                message: 'Please choose an image',
            });
        });

        const reader = new FileReader();
        reader.readAsDataURL(files[0]);
        reader.addEventListener('loadend', function(e) {
            img.src = e.target.result;
        });
    });
}
`} />
        </div>
        <p class="lh-copy">When the field is validated completely, we can get the custom data stored in the result's <code>meta</code>:</p>
        <div class="mb4">
            <SampleCode lang="javascript" code={`
formValidationInstance.on('core.validator.validated', function(e) {
    if (e.field === 'avatar' && e.validator === 'promise') {
        if (e.result.valid && e.result.meta && e.result.meta.source) {
            // Get the source of selected image
            const source = e.result.meta.source;

            // Display the avatar in the preview area
            ...
        } else if (!e.result.valid) {
            // Remove the preview
            ...
        }
    }
});
`} />                
        </div>

        <Demo prefix="/guide/validators/promise/basic" frameworks={['Bootstrap', 'Tachyons']} />
    </section>

    <RelatedValidators validators={['callback', 'remote']} />

    <section class="cf mb4">
        <div class="fl w-50 tl">
            <a href="/guide/validators/phone/" class="b blue dim link pa2">&larr; phone validator</a>
        </div>
        <div class="fl w-50 tr">
            <a href="/guide/validators/regexp/" class="b blue dim link pa2">regexp validator &rarr;</a>
        </div>
    </section>
</Guide>

<script>
export default {
    components: {
        Demo: '../../../../components/Demo.html',
        Guide: '../../../../components/Guide.html',
        RelatedValidators: '../../../../components/RelatedValidators.html',
        SampleCode: '../../../../components/SampleCode.html',
        Tip: '../../../../components/Tip.html',
    },

    data() {
        return {
            mimeTypes: {
                doc: 'application/msword',
                pdf: 'application/pdf',
                rtf: 'application/rtf',
                xls: 'application/vnd.ms-excel',
                ppt: 'application/vnd.ms-powerpoint',
                rar: 'application/x-rar-compressed',
                swf: 'application/x-shockwave-flash',
                zip: 'application/zip',
                'mid midi kar': 'audio/midi',
                mp3: 'audio/mpeg,audio/mp3',
                ogg: 'audio/ogg',
                m4a: 'audio/x-m4a',
                ra: 'audio/x-realaudio',
                gif: 'image/gif',
                'jpeg jpg': 'image/jpeg',
                png: 'image/png',
                'tif tiff': 'image/tiff',
                wbmp: 'image/vnd.wap.wbmp',
                ico: 'image/x-icon',
                jng: 'image/x-jng',
                bmp: 'image/x-ms-bmp',
                'svg svgz': 'image/svg+xml',
                webp: 'image/webp',
                css: 'text/css',
                'html htm shtml': 'text/html',
                txt: 'text/plain',
                xml: 'text/xml',
                '3gpp 3gp': 'video/3gpp',
                mp4: 'video/mp4',
                'mpeg mpg': 'video/mpeg',
                mov: 'video/quicktime',
                webm: 'video/webm',
                flv: 'video/x-flv',
                m4v: 'video/x-m4v',
                wmv: 'video/x-ms-wmv',
                avi: 'video/x-msvideo',
            },
        };
    },
};
</script>